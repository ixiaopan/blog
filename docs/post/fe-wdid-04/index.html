<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<title>WDID - Design a Video Player</title>



  
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-203640627-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-203640627-1');
  </script>
  




<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="alternate"
  type="application/rss+xml"
  href="https://ixiaopan.github.io/blog/index.xml"
  title=""
/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="WDID - Design a Video Player"/>
<meta name="twitter:description" content="业务最开始实现的视频播放功能用的是 xgplayer 插件，这个插件比较重，更侧重于直播。而我们业务所需要的仅仅是一个美化版本的 &lt;video&gt;，为此，我们需要基于 video api 实现自己的播放器。"/>




<link rel="stylesheet" href="https://ixiaopan.github.io/blog/fontawesome/css/all.min.css" />




<link
  crossorigin="anonymous"
  href="/blog/css/styles.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>


  <link rel="stylesheet" href="https://ixiaopan.github.io/blog/css/main.css" />



<link
  id="dark-mode-theme"
  crossorigin="anonymous"
  href="/blog/css/dark.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>


<script>
  var darkTheme = document.getElementById('dark-mode-theme')
  var storedTheme = localStorage.getItem('dark-mode-storage')
  if (storedTheme === 'dark') {
    darkTheme.disabled = false
  } else if (storedTheme === 'light') {
    darkTheme.disabled = true
  }
</script>



<script defer crossorigin="anonymous" src="/blog/js/theme.js" integrity=""></script>

<script src="https://ixiaopan.github.io/blog/js/instantpage.min.js" type="module" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css" integrity="sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js" integrity="sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>

 



<meta name="generator" content="Hugo 0.81.0" />
  </head>
  <body>
    
  




<header>
  <nav class="navbar">
  <div class="nav">
    
      <a href="https://ixiaopan.github.io/blog/" class="nav-logo">
        <img
          src="https://ixiaopan.github.io/blog/images/me.JPG"
          width="50"
          height="50"
          alt="Logo"
        />
      </a>
    

    <ul class="nav-links">
      
        
          <li>
            <a href="/blog/search" id="Search"
              ><em class="fas fa-search fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/blog/about" id="About"
              ><em class="fas fa-user fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/blog/categories" id="Category"
              ><em class="fas fa-folder-open fa-lg"></em
            ></a>
          </li>
          
      
    </ul>
  </div>
</nav>


  
  <div class="intro-header">
    <h1 class="post-heading">
      WDID - Design a Video Player
    </h1>
    <span class="meta-post">
  <em class="fa fa-calendar-alt"></em
  >&nbsp;Jun 21, 2023
  
  &nbsp;&nbsp;<i class="fas fa-clock"></i>&nbsp;4 min read

  
    &nbsp;&nbsp;&nbsp;<em class="fa fa-folder-open"></em>&nbsp;
    
      <a
        href="https://ixiaopan.github.io/blog/categories/frontend/"
        >Frontend</a
      >&nbsp;
    
  
</span>

  </div>
  
</header>

    
  <div class="container" role="main">
    <div class="inner">
      <article class="article" class="blog-post">
        
  <p>业务最开始实现的视频播放功能用的是 <code>xgplayer</code> 插件，这个插件比较重，更侧重于直播。而我们业务所需要的仅仅是一个美化版本的 <code>&lt;video&gt;</code>，为此，我们需要基于 <code>video api</code> 实现自己的播放器。</p>
<h2 id="组件">组件</h2>
<p>主要有3个模块</p>
<ul>
<li>
<p>视频预览</p>
</li>
<li>
<p>进度条</p>
<ul>
<li>seek</li>
</ul>
</li>
<li>
<p>播放控件</p>
<ul>
<li>play</li>
<li>pause</li>
<li>mute on</li>
<li>mute off</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">div</span>&gt;
&lt;<span style="color:#f92672">a-player-container</span> <span style="color:#a6e22e">ref</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;videoRef&#34;</span> <span style="color:#a6e22e">:width</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;width&#34;</span> <span style="color:#a6e22e">:height</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;height&#34;</span> <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">click</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;autoPlay&#34;</span>&gt;
  &lt;<span style="color:#f92672">a-spin</span> <span style="color:#a6e22e">v-show</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loading&#34;</span> /&gt;
&lt;/<span style="color:#f92672">a-player-container</span>&gt;

&lt;<span style="color:#f92672">a-progress</span>
  <span style="color:#a6e22e">seekable</span>
  <span style="color:#a6e22e">:pointer</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pointer&#34;</span>
  <span style="color:#a6e22e">:currentTime</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;currentTime&#34;</span>
  <span style="color:#a6e22e">:duration</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;duration&#34;</span>
  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">seek</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;onSeek&#34;</span>
  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">dragEnd</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;onSeek&#34;</span>
&gt;&lt;/<span style="color:#f92672">a-progress</span>&gt;

&lt;<span style="color:#f92672">a-player-control</span>
  <span style="color:#a6e22e">:currentTime</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;currentTime&#34;</span>
  <span style="color:#a6e22e">:duration</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;duration&#34;</span>
  <span style="color:#a6e22e">:muted</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;muted&#34;</span>
  <span style="color:#a6e22e">:playing</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;playing&#34;</span>
  <span style="color:#a6e22e">:format</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;format&#34;</span>
  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">pause</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pause&#34;</span>
  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">play</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;play&#34;</span>
  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">muteOn</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;openMute&#34;</span>
  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">muteOff</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;closeMute&#34;</span>
/&gt;
&lt;/<span style="color:#f92672">div</span>&gt;
</code></pre></div><h2 id="api">API</h2>
<p>定义一个类 <code>MyVideo</code>，至少需要暴露以下几个方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyVideo</span> {
  <span style="color:#a6e22e">play</span>() {
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>) <span style="color:#66d9ef">return</span>

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">paused</span>) <span style="color:#66d9ef">return</span>

    <span style="color:#75715e">// ready to play for the next frame
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">readyState</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;not ready 2&#39;</span>)

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">play</span>()
  }
  <span style="color:#a6e22e">pause</span>() {
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>) <span style="color:#66d9ef">return</span>

    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">paused</span>) <span style="color:#66d9ef">return</span>

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">pause</span>()
  }
  <span style="color:#a6e22e">openMute</span>() {
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">muted</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
  }
  <span style="color:#a6e22e">closeMute</span>() {
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">muted</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
  }
  <span style="color:#a6e22e">seek</span>(<span style="color:#a6e22e">ms</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">number</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">currentTime</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ms</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000</span>
  }
  <span style="color:#a6e22e">destroy</span>() {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pause</span>()
    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>) {
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">container</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">removeChild</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>)
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>
    }
  }
}
</code></pre></div><h3 id="入参">入参</h3>
<p>接下来定义入参，很容易想到，至少要告诉我一个 <code>url</code> 吧，其他参数可以是预加载、自动播放、循环播放、事件等和官方 API对齐即可</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IOption</span> {
  <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>
  <span style="color:#a6e22e">container</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">HTMLElement</span> <span style="color:#75715e">// 包含视频的容器
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">width</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">number</span> <span style="color:#75715e">// 视频的宽高
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">height</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">number</span>

  <span style="color:#a6e22e">poster</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">string</span> <span style="color:#75715e">// 视频的封面
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">preload</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">string</span> <span style="color:#75715e">// metadata, none, auto
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">autoplay</span><span style="color:#f92672">?:</span> <span style="color:#66d9ef">boolean</span>
  <span style="color:#a6e22e">loop</span><span style="color:#f92672">?:</span> <span style="color:#66d9ef">boolean</span>
  <span style="color:#a6e22e">muted</span><span style="color:#f92672">?:</span> <span style="color:#66d9ef">boolean</span>

  <span style="color:#a6e22e">onLoadedMetadata</span><span style="color:#f92672">?:</span> (<span style="color:#a6e22e">duration</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">number</span>) =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onLoadedData</span><span style="color:#f92672">?:</span> () =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onSeeking</span><span style="color:#f92672">?:</span> () =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onSeeked</span><span style="color:#f92672">?:</span> () =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onWaiting</span><span style="color:#f92672">?:</span> () =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onPlaying</span><span style="color:#f92672">?:</span> () =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onProgress</span><span style="color:#f92672">?:</span> (<span style="color:#a6e22e">progress</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">number</span>) =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onPlay</span><span style="color:#f92672">?:</span> () =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onPause</span><span style="color:#f92672">?:</span> () =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onAbort</span><span style="color:#f92672">?:</span> () =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onEnd</span><span style="color:#f92672">?:</span> () =&gt; <span style="color:#66d9ef">void</span>
  <span style="color:#a6e22e">onError</span><span style="color:#f92672">?:</span> (<span style="color:#a6e22e">err</span><span style="color:#f92672">:</span> Error) =&gt; <span style="color:#66d9ef">void</span>
}
</code></pre></div><h3 id="加载视频">加载视频</h3>
<p>这里采用动态加载 <code>video</code> 插入到 <code>DOM</code> 的方式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyVideo</span> {
  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">init</span>() {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">createVideo</span>()

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">bindEvents</span>()

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">container</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">appendChild</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>)
  }
  
  <span style="color:#a6e22e">createVideo</span>() {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">video</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;video&#39;</span>)

    <span style="color:#a6e22e">video</span>.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#e6db74">&#39;preload&#39;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">preload</span><span style="color:#f92672">!</span>)
    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">poster</span>) {
      <span style="color:#a6e22e">video</span>.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#e6db74">&#39;poster&#39;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">poster</span>)
    }
    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">autoplay</span>) {
      <span style="color:#a6e22e">video</span>.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#e6db74">&#39;autoplay&#39;</span>, <span style="color:#e6db74">&#39;true&#39;</span>)
    }
    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">muted</span>) {
      <span style="color:#a6e22e">video</span>.<span style="color:#a6e22e">muted</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
    }
    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">loop</span>) {
      <span style="color:#a6e22e">video</span>.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#e6db74">&#39;loop&#39;</span>, <span style="color:#e6db74">&#39;true&#39;</span>)
    }

    <span style="color:#a6e22e">video</span>.<span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">url</span>
    
    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">width</span>) {
      <span style="color:#a6e22e">video</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">width</span>
    }
    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">height</span>) {
      <span style="color:#a6e22e">video</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">height</span>
    }

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">video</span>
  }
}
</code></pre></div><h3 id="定义事件">定义事件</h3>
<p><code>Video</code> 的官方文档就已经提供了很多钩子，我们直接使用接口，比如</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyVideo</span> {
  <span style="color:#a6e22e">bindEvents</span>() {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;play&#39;</span>, () =&gt; {
      <span style="color:#66d9ef">typeof</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">onPlay</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;function&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">onPlay</span>()
    })
  }
}
</code></pre></div><h2 id="预加载内容">预加载内容</h2>
<p><code>preload</code> 属性支持</p>
<ul>
<li>
<p><code>auto</code> 表示视频内容可以被下载，由浏览器决定</p>
</li>
<li>
<p><code>metadata</code> 只预加载视频的元信息，比如视频长度</p>
</li>
<li>
<p><code>none</code> 视频不会被预加载</p>
</li>
</ul>
<p>因为每个浏览器的默认值不一样，同时在我们的业务里，视频时长是很有用的信息，所以我们默认取  <code>metadata</code></p>
<p>另个预加载的方式是通过使用 <code>video.load()</code> 这个方法(加载的内容也是通过 <code>preload</code> 属性决定的），不过它更适用于视频的 <code>src</code> 发生改变的情况</p>
<h2 id="timeupdate-更新卡顿">timeupdate 更新卡顿</h2>
<p>这里遇到一个问题，在 <code>timeupdate</code> 通过回调在 <code>UI</code> 层更新进度条的时候，会卡顿，原因是 <code>timeupdate</code> 的触发频率是 <code>250ms</code> 一次</p>
<blockquote>
<p>The timeupdate event is fired when the time indicated by the currentTime attribute has been updated.
The event frequency is dependent on the system load, but will be thrown between about 4Hz and 66Hz (assuming the event handlers don&rsquo;t take longer than 250ms to run)</p>
</blockquote>
<p>为了解决这个问题，我们需要在 <code>timeupdate</code> 里频繁的触发回调，才能达到丝滑般的滚动条前进效果</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;timeupdate&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clearTimer</span>()

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">step</span> <span style="color:#f92672">=</span> () =&gt; {
    <span style="color:#75715e">// float second
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">currentTime</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span><span style="color:#f92672">!</span>.<span style="color:#a6e22e">currentTime</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
    
    <span style="color:#66d9ef">typeof</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">onProgress</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;function&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">onProgress</span>(<span style="color:#a6e22e">currentTime</span>)

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">timer</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">requestAnimationFrame</span>(<span style="color:#a6e22e">step</span>)

  }
  <span style="color:#a6e22e">step</span>()
})
</code></pre></div><p>同时需要在其他可能的地方，防止内存泄露，比如</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyVideo</span> {
  <span style="color:#a6e22e">bindEvents</span>() {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;pause&#39;</span>, () =&gt; {
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clearTimer</span>()
    })
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;abort&#39;</span>, () =&gt; {
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clearTimer</span>()
    })
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;ended&#39;</span>, () =&gt; {
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clearTimer</span>()
    })
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;error&#39;</span>, () =&gt; {
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clearTimer</span>()
    })
  }
  <span style="color:#a6e22e">clearTimer</span>() {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">timer</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">cancelAnimationFrame</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">timer</span>)
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">timer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>
  }
  <span style="color:#a6e22e">destroy</span>() {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clearTimer</span>()
    ....
  }
}
</code></pre></div><h2 id="refer">Refer</h2>
<ul>
<li>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement#instance_methods">HTMLMediaElement - MDN</a></p>
</li>
<li>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/timeupdate_event">timeupdate_event - MDN</a></p>
</li>
</ul>



        
      </article>

      
      <aside class="article-aside">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#组件">组件</a></li>
    <li><a href="#api">API</a>
      <ul>
        <li><a href="#入参">入参</a></li>
        <li><a href="#加载视频">加载视频</a></li>
        <li><a href="#定义事件">定义事件</a></li>
      </ul>
    </li>
    <li><a href="#预加载内容">预加载内容</a></li>
    <li><a href="#timeupdate-更新卡顿">timeupdate 更新卡顿</a></li>
    <li><a href="#refer">Refer</a></li>
  </ul>
</nav>
      
      </aside>
    </div>
    
    
    
    
      

    
  </div>

    <footer>
  

<div class="social-icons">
  
    
    
      
      <a href="mailto:?to=xiaopan.wpp@outlook.com" name="Email">
        <em class="fas fa-envelope"></em>
      </a>
    
       &nbsp;&nbsp;&nbsp;
      <a href="https://github.com/ixiaopan" name="GitHub">
        <em class="fab fa-github"></em>
      </a>
    
       &nbsp;&nbsp;&nbsp;
      <a href="https://www.linkedin.com/in/ixiaopan" name="Linkedin">
        <em class="fab fa-linkedin"></em>
      </a>
    
       &nbsp;&nbsp;&nbsp;
      <a href="https://space.bilibili.com/22910840" name="Bilibili">
        <em class="fab fa-youtube"></em>
      </a>
    
  

  
</div>


  
  <div class="container">
    <p class="credits copyright">
      <a href="https://ixiaopan.github.io/blog/about">ixiaopan</a>
      &nbsp;&copy;
      2023
      
      &nbsp;&ndash;&nbsp;
      <em class="fas fa-moon" id="dark-mode-toggle"></em>
    </p>

    <p class="credits theme-by">
      Powered By <a href="https://gohugo.io">Hugo</a>&nbsp;
      Theme
      <a href="https://github.com/matsuyoshi30/harbor">Harbor</a>
    </p>
  </div>
</footer>

  </body>
</html>
