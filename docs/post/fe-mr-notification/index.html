<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<title>Automatically Send MR Notification</title>



  




<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="alternate"
  type="application/rss+xml"
  href="https://ixiaopan.github.io/blog/index.xml"
  title=""
/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Automatically Send MR Notification"/>
<meta name="twitter:description" content=""/>




<link rel="stylesheet" href="https://ixiaopan.github.io/blog/fontawesome/css/all.min.css" />




<link
  crossorigin="anonymous"
  href="/blog/css/styles.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>


  <link rel="stylesheet" href="https://ixiaopan.github.io/blog/css/main.css" />



<link
  id="dark-mode-theme"
  crossorigin="anonymous"
  href="/blog/css/dark.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>


<script>
  var darkTheme = document.getElementById('dark-mode-theme')
  var storedTheme = localStorage.getItem('dark-mode-storage')
  if (storedTheme === 'dark') {
    darkTheme.disabled = false
  } else if (storedTheme === 'light') {
    darkTheme.disabled = true
  }
</script>



<script defer crossorigin="anonymous" src="/blog/js/theme.js" integrity=""></script>

<script src="https://ixiaopan.github.io/blog/js/instantpage.min.js" type="module" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css" integrity="sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js" integrity="sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>

 



<meta name="generator" content="Hugo 0.91.0" />
  </head>
  <body>
    
  




<header>
  <nav class="navbar">
  <div class="nav">
    
      <a href="https://ixiaopan.github.io/blog/" class="nav-logo">
        <img
          src="https://ixiaopan.github.io/blog/images/me.JPG"
          width="50"
          height="50"
          alt="Logo"
        />
      </a>
    

    <ul class="nav-links">
      
        
          <li>
            <a href="/blog/search" id="Search"
              ><em class="fas fa-search fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/blog/about" id="About"
              ><em class="fas fa-user fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/blog/categories" id="Category"
              ><em class="fas fa-folder-open fa-lg"></em
            ></a>
          </li>
          
      
    </ul>
  </div>
</nav>


  
  <div class="intro-header">
    <h1 class="post-heading">
      Automatically Send MR Notification
    </h1>
    <span class="meta-post">
  <em class="fa fa-calendar-alt"></em
  >&nbsp;Jan 28, 2023
  
  &nbsp;&nbsp;<i class="fas fa-clock"></i>&nbsp;6 min read

  
    &nbsp;&nbsp;&nbsp;<em class="fa fa-folder-open"></em>&nbsp;
    
      <a
        href="https://ixiaopan.github.io/blog/categories/frontend/"
        >Frontend</a
      >&nbsp;
    
  
</span>

  </div>
  
</header>

    
  <div class="container" role="main">
    <div class="inner">
      <article class="article" class="blog-post">
        
  <h2 id="why">Why</h2>
<p>过去一年，团队开展了 MR 机制，但是效果不是很理想，原因有几个：</p>
<ul>
<li>会 CR 的人太少</li>
<li>缺少时间</li>
<li>缺少 CR 规范</li>
<li>MR 通知不及时</li>
<li>&hellip;</li>
</ul>
<p>在人少需求不多的时候，这些问题都是可接受的。但是现在随着团队规模的扩大，这些问题就变得尖锐起来，这就需要规范且自动化，从而提高工作效率和代码质量。</p>
<p>回看上面的原因，其实也就2个大问题</p>
<ul>
<li>不知道怎么CR</li>
<li>发起MR后，未及时感知</li>
</ul>
<p>第一个问题的解决方法，可以是制定相关规范，让大家『有迹可循』，看多了也就知道问题在哪了；第二个问题，那就是自动化的问题，可以选择接入机器人，通知到 <code>IM</code>。</p>
<p>所以，这篇文章就是简单介绍一下如何接入 <code>gitlab</code> 的 <code>webhook</code> 实现 <code>MR</code> 的自动通知</p>
<h2 id="how">How</h2>
<p>整体流程分为几步</p>
<ul>
<li>
<p>拦截 MR 相关事件(open/update/close)</p>
</li>
<li>
<p>提取需要的信息</p>
</li>
<li>
<p>定时发送消息到 <code>IM</code>，这里我们用 飞书 举例</p>
</li>
</ul>
<h3 id="step-1-webhook">Step 1 Webhook</h3>
<p><code>gitlab</code> 本身就提供了 <code>webhook</code> 允许自建应用响应 <code>gitlab</code> 相关事件，比如</p>
<ul>
<li>push</li>
<li>tag</li>
<li>issue</li>
<li>merge request</li>
<li>&hellip;</li>
</ul>
<p>其中 <code>Merge request</code> 又支持多个 <code>action</code></p>
<ul>
<li>open</li>
<li>close</li>
<li>update</li>
<li>merge</li>
<li>&hellip;</li>
</ul>
<p>在 <code>gitlab</code> 的 <code>settings =&gt; Webhooks</code> 里，填写如下信息</p>
<ul>
<li>
<p><code>webhook url</code> 即 <code>application endpoint</code>，比如 <code>https://examples.com/gitlab-mr</code></p>
</li>
<li>
<p><code>security token</code> 会附加在请求头 <code>X-Gitlab-Token</code> ，进行安全校验，自定义字符串即可</p>
</li>
<li>
<p><code>Trigger</code> 根据自己的需求勾选，这里就是 <code>mr</code> 了</p>
</li>
</ul>
<p>据此，我们定义以下 <code>enum</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// X-Gitlab-Token HTTP header
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">GITLAB_WEBHOOK_TOKEN</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;your custom string&#39;</span>

<span style="color:#75715e">// 支持的事件类型
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">GITLAB_EVENT_TYPE</span> {
  <span style="color:#75715e">// a new comment is made on commits, merge requests, issues, and code snippets
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">COMMENT</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;note&#39;</span>,
  <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">MERGE_REQUEST</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;merge_request&#39;</span>,
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">MR_ACTION</span> {
  <span style="color:#a6e22e">open</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;open&#39;</span>,
  <span style="color:#a6e22e">reopen</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;reopen&#39;</span>,
  <span style="color:#a6e22e">update</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;update&#39;</span>,

  <span style="color:#a6e22e">merge</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;merge&#39;</span>,
  <span style="color:#a6e22e">close</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;close&#39;</span>,

  <span style="color:#a6e22e">approved</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;approved&#39;</span>,
  <span style="color:#a6e22e">unapproved</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;unapproved&#39;</span>,
}

</code></pre></div><h3 id="step-2-server">Step 2 Server</h3>
<p>搭建应用的话，可以选用 <code>koa</code> 起一个简单的 <code>node server</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Koa</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;koa&#39;</span>
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">KoaRouter</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;@koa/router&#39;</span>
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">gitlabHookHandler</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./gitlab/handler&#39;</span>
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">koaBody</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;koa-body&#39;</span>

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Koa</span>()
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">router</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">KoaRouter</span>()

<span style="color:#a6e22e">router</span>
.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/&#39;</span>, () =&gt; {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;hello world&#39;</span>)
})
<span style="color:#75715e">// your own endpoint
</span><span style="color:#75715e"></span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#39;/gitlab-mr&#39;</span>, <span style="color:#a6e22e">gitlabHookHandler</span>)

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">koaBody</span>())
<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">routes</span>())

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">3000</span>)
</code></pre></div><h4 id="api-validation">API Validation</h4>
<p>首先是边界处理，包括</p>
<ul>
<li>
<p><code>Invalid Security Token</code> 这个就是前面 <code>settings =&gt; webhooks</code> 里的 <code>Security Token</code></p>
</li>
<li>
<p><code>Empty Body</code></p>
</li>
<li>
<p><code>Invalid EVENT_TYPE</code> 不是所有 <code>gitlab</code> 的事件都要处理</p>
</li>
<li>
<p><code>Invalid Projects</code> 只接受指定项目的 <code>webhook</code></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">gitlabHookHandler</span>(<span style="color:#a6e22e">ctx</span>) {
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">headers</span>, <span style="color:#a6e22e">body</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">request</span>
  
  <span style="color:#75715e">// Token Validation
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">token</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">headers</span>[<span style="color:#e6db74">&#39;X-Gitlab-Token&#39;</span>] <span style="color:#f92672">||</span> <span style="color:#a6e22e">headers</span>[<span style="color:#e6db74">&#39;x-gitlab-token&#39;</span>]
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">token</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">GITLAB_WEBHOOK_TOKEN</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">responseError</span>(<span style="color:#e6db74">&#39;invalid Secret Token&#39;</span>)
  }

  <span style="color:#75715e">// Empty Body
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">body</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">responseError</span>(<span style="color:#e6db74">&#39;Empty Response&#39;</span>)
  }

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">eventType</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">object_kind</span>
  <span style="color:#75715e">// Check Event Type
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>Object.<span style="color:#a6e22e">values</span>(<span style="color:#a6e22e">GITLAB_EVENT_TYPE</span>).<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">eventType</span>)) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">responseError</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">eventType</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> event is not supported`</span>)
  }
  
  <span style="color:#75715e">// Project Validation
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">name</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">project</span> <span style="color:#f92672">||</span> {}
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">GITLAB_PROJECT_LIST</span>.<span style="color:#a6e22e">find</span>(<span style="color:#a6e22e">p</span> =&gt; <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">id</span>)) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">responseError</span>(<span style="color:#e6db74">`Project [</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">] does not exist`</span>)
  }
}
</code></pre></div><p>一切都通过之后，就会进入 <code>MergeRequest Handler</code> 得到聚合后的数据，然后发送给 IM</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">mergeRequestHook</span>(<span style="color:#a6e22e">body</span>)
<span style="color:#a6e22e">sendMR</span>(<span style="color:#a6e22e">data</span>)
<span style="color:#a6e22e">responseSuccess</span>()
</code></pre></div><h4 id="mr-handler">MR Handler</h4>
<p>When do we need MR notifications? Here are some cases</p>
<ul>
<li>
<p>Open a MR with or w/o an assignee</p>
</li>
<li>
<p>Close a MR</p>
</li>
<li>
<p>Merge a MR</p>
</li>
</ul>
<p>As mentioned before, <code>data.object_attributes.action</code> tells us which action is triggered.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">mergeRequestHook</span>(<span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IMergeRequestEvent</span>) {
  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">action</span>, } <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">object_attributes</span>
  
  <span style="color:#75715e">// basic data about the project and MR
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">basicInfo</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#75715e">// mr url
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#75715e">// mr title
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#75715e">// mr description
</span><span style="color:#75715e"></span>  }

  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">action</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">MR_ACTION</span>.<span style="color:#a6e22e">close</span>) {
    <span style="color:#66d9ef">return</span> {
      ...<span style="color:#a6e22e">basicInfo</span>,
    }
  }
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">action</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">MR_ACTION</span>.<span style="color:#a6e22e">open</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">action</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">MR_ACTION</span>.<span style="color:#a6e22e">reopen</span>) {
    <span style="color:#66d9ef">return</span> {
      ...<span style="color:#a6e22e">basicInfo</span>,
    }
  }
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">action</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">MR_ACTION</span>.<span style="color:#a6e22e">merge</span>) {
    <span style="color:#66d9ef">return</span> {
      ...<span style="color:#a6e22e">basicInfo</span>,
    }
  }

  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`MR action [</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">action</span><span style="color:#e6db74">}</span><span style="color:#e6db74">] is not supported`</span>)
}
</code></pre></div><p>The above snippet does only one thing: collect data to be sent to IM.</p>
<h4 id="userid">UserId</h4>
<p>For now, we have only data about the project and MR, but no user information. Specifically speaking, we don&rsquo;t have the user id in Feishu. There are 2 ways to tackle this</p>
<ul>
<li>save everyone&rsquo;s user id in the config file</li>
<li>get userId by user&rsquo;s mobile/email via Feishu API (we need to apply for token)</li>
</ul>
<p>Once we have the userId, we can send the above information to someone in Feishu. Here is an example,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// the local user config file (Security Risk)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">USER_LIST</span> <span style="color:#f92672">=</span> [
  {
    <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">01</span>, <span style="color:#75715e">// userId in gitlab
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;gitlab user name&#39;</span>,
    <span style="color:#a6e22e">userId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;userId in Feishu&#39;</span>,
  },
]

<span style="color:#75715e">// 获取IM的用户id
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getUserIdByGitId</span>(<span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">number</span>) {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">USER_LIST</span>.<span style="color:#a6e22e">find</span>(<span style="color:#a6e22e">o</span> =&gt; <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">id</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">userId</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;&#39;</span>
}
</code></pre></div><p>How to at someone?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// set username as the default value, if id does not exist
</span><span style="color:#75715e"></span><span style="color:#e6db74">&#34;content&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`&lt;at id=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&gt;&lt;/at&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>
</code></pre></div><h3 id="step-3-schedule">Step 3 Schedule</h3>
<p>以上实现的功能都比较被动，即需要等待事件被触发。假设想知道每天遗留的未处理MR的信息，then</p>
<ul>
<li>
<p>主动发起 <code>API</code> 到 <code>gitlab</code></p>
</li>
<li>
<p>设定每日定时提醒即可</p>
</li>
</ul>
<p>首先申请 <code>Token</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">GITLAB_API_V4</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">GITLAB_HOST</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/api/v4/`</span>

<span style="color:#75715e">// TODO: Security Risk
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">GITLAB_PERSONAL_ACCESS_TOKEN</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;your token&#39;</span>
</code></pre></div><p>根据文档，只要知道 <code>projectId</code> 就能获取对应项目的 <code>MR</code> 列表，<code>Node</code> 端我们依然选用 <code>Axios</code> 发起 <code>HTTP</code> 请求，同时注意，要把之前申请的 <code>Token</code> 带到请求头</p>
<p>参考</p>
<ul>
<li>
<p><a href="https://docs.gitlab.com/ee/api/rest/#personalprojectgroup-access-tokens">Gitlab Doc#personal-access-tokens</a></p>
</li>
<li>
<p><a href="https://docs.gitlab.com/ee/api/merge_requests.html#list-project-merge-requests">GItlab Doc#list-project-mr</a></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">request</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">axios</span>.<span style="color:#a6e22e">create</span>({
  <span style="color:#a6e22e">baseURL</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">GITLAB_API_V4</span>,
  <span style="color:#a6e22e">timeout</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>,
  <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> { <span style="color:#e6db74">&#39;Private-Token&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">GITLAB_PERSONAL_ACCESS_TOKEN</span> }
})

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fetchOpenedMRList</span>(<span style="color:#a6e22e">projectId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">number</span>) {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">`/projects/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">projectId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/merge_requests?state=opened`</span>)
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createMRMention</span>() {
  <span style="color:#66d9ef">try</span> {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">allP</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> Promise.<span style="color:#a6e22e">all</span>(<span style="color:#a6e22e">GITLAB_PROJECT_LIST</span>.<span style="color:#a6e22e">map</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">p</span>) =&gt; {
      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetchOpenedMRList</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>)
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">data</span>
    }))
    
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;fetch opened mr done&#39;</span>);
    
    <span style="color:#a6e22e">allP</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IMergeRequest</span>[]) =&gt; { <span style="color:#75715e">// each project
</span><span style="color:#75715e"></span>      <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">res</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IMergeRequest</span>) =&gt; { <span style="color:#75715e">// each mr
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>      })
    })

    <span style="color:#a6e22e">sendRichText</span>(<span style="color:#e6db74">&#39;MR 处理提醒&#39;</span>, <span style="color:#a6e22e">content</span>)
  }
  <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#39;fetchOpenedMR Error&#39;</span>, <span style="color:#a6e22e">e</span>)
  }
}
</code></pre></div><p>最后，每天下午5点发起提醒</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">later</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;@breejs/later&#39;</span>)

<span style="color:#a6e22e">later</span>.<span style="color:#a6e22e">date</span>.<span style="color:#a6e22e">localTime</span>()
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">s</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">later</span>.<span style="color:#a6e22e">parse</span>.<span style="color:#a6e22e">text</span>(<span style="color:#e6db74">&#39;at 5:00 pm&#39;</span>)
<span style="color:#a6e22e">later</span>.<span style="color:#a6e22e">setInterval</span>(<span style="color:#a6e22e">createMRMention</span>, <span style="color:#a6e22e">s</span>)
</code></pre></div><h2 id="summary">Summary</h2>
<p>完整的代码，<a href="https://github.com/ixiaopan/DataScience/tree/master/GitlabWebhook">点击这里</a></p>



        
      </article>

      
      <aside class="article-aside">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#why">Why</a></li>
    <li><a href="#how">How</a>
      <ul>
        <li><a href="#step-1-webhook">Step 1 Webhook</a></li>
        <li><a href="#step-2-server">Step 2 Server</a></li>
        <li><a href="#step-3-schedule">Step 3 Schedule</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
      
      </aside>
    </div>
    
    
    
    
      

    
  </div>

    <footer>
  

<div class="social-icons">
  
    
    
      
      <a href="mailto:?to=xiaopan.wpp@outlook.com" name="Email">
        <em class="fas fa-envelope"></em>
      </a>
    
       &nbsp;&nbsp;&nbsp;
      <a href="https://github.com/ixiaopan" name="GitHub">
        <em class="fab fa-github"></em>
      </a>
    
       &nbsp;&nbsp;&nbsp;
      <a href="https://www.linkedin.com/in/ixiaopan" name="Linkedin">
        <em class="fab fa-linkedin"></em>
      </a>
    
       &nbsp;&nbsp;&nbsp;
      <a href="https://space.bilibili.com/22910840" name="Bilibili">
        <em class="fab fa-youtube"></em>
      </a>
    
  

  
</div>


  
  <div class="container">
    <p class="credits copyright">
      <a href="https://ixiaopan.github.io/blog/about">ixiaopan</a>
      &nbsp;&copy;
      2023
      
      &nbsp;&ndash;&nbsp;
      <em class="fas fa-moon" id="dark-mode-toggle"></em>
    </p>

    <p class="credits theme-by">
      Powered By <a href="https://gohugo.io">Hugo</a>&nbsp;
      Theme
      <a href="https://github.com/matsuyoshi30/harbor">Harbor</a>
    </p>
  </div>
</footer>

  </body>
</html>
