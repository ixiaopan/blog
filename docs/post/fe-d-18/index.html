<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<title>D - 基建 API Mock</title>



  




<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="alternate"
  type="application/rss+xml"
  href="https://ixiaopan.github.io/blog/index.xml"
  title=""
/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="D - 基建 API Mock"/>
<meta name="twitter:description" content=""/>




<link rel="stylesheet" href="https://ixiaopan.github.io/blog/fontawesome/css/all.min.css" />




<link
  crossorigin="anonymous"
  href="/blog/css/styles.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>


  <link rel="stylesheet" href="https://ixiaopan.github.io/blog/css/main.css" />



<link
  id="dark-mode-theme"
  crossorigin="anonymous"
  href="/blog/css/dark.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>


<script>
  var darkTheme = document.getElementById('dark-mode-theme')
  var storedTheme = localStorage.getItem('dark-mode-storage')
  if (storedTheme === 'dark') {
    darkTheme.disabled = false
  } else if (storedTheme === 'light') {
    darkTheme.disabled = true
  }
</script>



<script defer crossorigin="anonymous" src="/blog/js/theme.js" integrity=""></script>

<script src="https://ixiaopan.github.io/blog/js/instantpage.min.js" type="module" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css" integrity="sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js" integrity="sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>

 



<meta name="generator" content="Hugo 0.91.0" />
  </head>
  <body>
    
  




<header>
  <nav class="navbar">
  <div class="nav">
    
      <a href="https://ixiaopan.github.io/blog/" class="nav-logo">
        <img
          src="https://ixiaopan.github.io/blog/images/me.JPG"
          width="50"
          height="50"
          alt="Logo"
        />
      </a>
    

    <ul class="nav-links">
      
        
          <li>
            <a href="/blog/search" id="Search"
              ><em class="fas fa-search fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/blog/about" id="About"
              ><em class="fas fa-user fa-lg"></em
            ></a>
          </li>
          
      
        
          <li>
            <a href="/blog/categories" id="Category"
              ><em class="fas fa-folder-open fa-lg"></em
            ></a>
          </li>
          
      
    </ul>
  </div>
</nav>


  
  <div class="intro-header">
    <h1 class="post-heading">
      D - 基建 API Mock
    </h1>
    <span class="meta-post">
  <em class="fa fa-calendar-alt"></em
  >&nbsp;Aug 23, 2023
  
  &nbsp;&nbsp;<i class="fas fa-clock"></i>&nbsp;6 min read

  
    &nbsp;&nbsp;&nbsp;<em class="fa fa-folder-open"></em>&nbsp;
    
      <a
        href="https://ixiaopan.github.io/blog/categories/frontend/"
        >Frontend</a
      >&nbsp;
    
  
</span>

  </div>
  
</header>

    
  <div class="container" role="main">
    <div class="inner">
      <article class="article" class="blog-post">
        
  <h2 id="background">Background</h2>
<p>开发没有mock还是比较痛苦的，最开始接入mock-server需要在业务里新开一个 <code>mock</code> 手动写 json，维护成本很高，也不利于共享。一直以来，都想着接入现在开源的mock产品，但是，一方面需要收钱，一方面比较复杂需要自己搭建服务&amp;数据，一致拖到现在还没有顺手的mock方案。</p>
<p>最近决定自己写个简单的，可能有人说你又在创建轮子，我的想法是，</p>
<ul>
<li>一方面我只开发mock功能，不支持其他比如api自动化测试的功能，我要的功能就是mock</li>
<li>另一方面mock通常只是在开发阶段才用到，就那么2天时间，后面进入联调就不会使用了</li>
<li>再有就是用来测试接口超时等异常情况</li>
</ul>
<p>综上，一个简单的mock平台足以满足我的需求，实际上，做这么个平台也就需要1天时间而已。</p>
<h2 id="mock平台">Mock平台</h2>
<h3 id="创建项目">创建项目</h3>
<p>每个业务需要创建对应的项目，我们就简单点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">MockProjectSchema</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">mongoose</span>.<span style="color:#a6e22e">Schema</span>({
  <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">String</span>,
  <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">String</span>,
  <span style="color:#a6e22e">desc</span>: <span style="color:#66d9ef">String</span>,
})
</code></pre></div><p>这里 <code>id</code> 才是最关键的，后续业务要使用</p>
<h3 id="创建-api">创建 API</h3>
<p><code>api</code> 层只要几个功能</p>
<ul>
<li>
<p>支持 <code>GET/POST</code></p>
</li>
<li>
<p>支持超时 <code>timeout</code></p>
</li>
<li>
<p>一个 <code>json editor</code></p>
</li>
</ul>
<p>至于 <code>api</code> 的匹配，一期做个模糊匹配即可，也就是只关心 <code>method/url</code>，不考虑入参</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">MockAPISchema</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">mongoose</span>.<span style="color:#a6e22e">Schema</span>({
  <span style="color:#a6e22e">projectId</span>: <span style="color:#66d9ef">String</span>,
  <span style="color:#a6e22e">url</span>: <span style="color:#66d9ef">String</span>,
  <span style="color:#a6e22e">desc</span>: <span style="color:#66d9ef">String</span>,
  <span style="color:#a6e22e">method</span>: <span style="color:#66d9ef">String</span>,
  <span style="color:#a6e22e">mocked</span>: <span style="color:#66d9ef">Boolean</span>,
  <span style="color:#a6e22e">timeout</span>: <span style="color:#66d9ef">Number</span>, <span style="color:#75715e">// 超时时间
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">json</span>: <span style="color:#66d9ef">String</span>, <span style="color:#75715e">// 出参
</span><span style="color:#75715e"></span>})
</code></pre></div><p>然后就是对应的 <code>crud</code> 接口实现，比较简单，这里就简单举个例子，不再赘述。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MockMeController</span> {
  <span style="color:#a6e22e">prefix</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/mockme&#39;</span>

  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">queryProjectById</span>(<span style="color:#a6e22e">ctx</span>: <span style="color:#66d9ef">any</span>) {
    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">id</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">params</span>
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">MockProjectModel</span>.<span style="color:#a6e22e">findOne</span>({ <span style="color:#a6e22e">id</span> }, { <span style="color:#a6e22e">__v</span>: <span style="color:#66d9ef">0</span>, <span style="color:#a6e22e">_id</span>: <span style="color:#66d9ef">0</span> })
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>
  }
}
</code></pre></div><h2 id="业务接入">业务接入</h2>
<p>重点看看，业务怎么接入平台</p>
<h3 id="mock-option">mock option</h3>
<p>从开发者的角度思考，他只需要在 <code>api</code> 这个文件对需要 mock 的 api，加一个参数即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">async</span> <span style="color:#a6e22e">queryList() {</span>
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">request</span>.<span style="color:#66d9ef">get</span>({
    <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;test/list&#39;</span>,
  }, {
    <span style="color:#a6e22e">mock</span>: <span style="color:#66d9ef">true</span>, <span style="color:#75715e">// 开启 mock
</span><span style="color:#75715e"></span>  })
}
</code></pre></div><p>要想拿到 mock 数据，必须和 mock 平台关联，也就是要拦截请求，代理到平台的地址。以 <code>axios</code> 为例，我们封装如下方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">get</span>(<span style="color:#a6e22e">confg</span>, <span style="color:#a6e22e">option</span>) {
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">request</span>({ ...<span style="color:#a6e22e">conf</span>, <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;get&#39;</span>, }, <span style="color:#a6e22e">option</span>)
}
<span style="color:#66d9ef">async</span> <span style="color:#a6e22e">request</span>(<span style="color:#a6e22e">conf</span>, <span style="color:#a6e22e">option</span>) {
  <span style="color:#75715e">// 判断接口是否开启了 mock
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">option</span>.<span style="color:#a6e22e">mock</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">mockUrl</span><span style="color:#e6db74">}${</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">url</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">url</span>
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">axios</span>.<span style="color:#a6e22e">request</span>(<span style="color:#a6e22e">conf</span>)
}
</code></pre></div><p>这段代码判断是否开启了 mock，如果开启，则把 <code>mockUrl</code> 和业务的 <code>url</code> 拼接起来，这里的 <code>mockUrl</code> 是代理到平台的地址，这样就实现了请求的拦截。</p>
<p>不过，这里会有跨域的问题，后面会解决这个问题</p>
<h3 id="mock-url">mock url</h3>
<p><code>mockUrl</code> 是 <code>mock</code> 平台提供的，前面我们说过每个业务对应一个mock项目，也就会有对应唯一的项目id，平台根据这个 id会自动生成一个地址，格式如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">https:</span><span style="color:#75715e">//test.com/mockme/proxy/:projectId
</span></code></pre></div><ul>
<li>
<p><code>test.com</code> 是平台服务器地址</p>
</li>
<li>
<p><code>/mockme/proxy</code>是路由</p>
</li>
<li>
<p><code>projectId</code> 就是每个业务在 mock 平台的项目 id</p>
</li>
</ul>
<p>举个例子</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#75715e">// 项目一
</span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//test.com/mockme/proxy/elem
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 项目二
</span><span style="color:#75715e"></span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//test.com/mockme/proxy/ant-design
</span></code></pre></div><p>请求打到平台后，平台会有对应的接口处理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MockMeController</span> {
  ...
  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">proxyAPI</span>(<span style="color:#a6e22e">ctx</span>: <span style="color:#66d9ef">any</span>) {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">urlRegResult</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">path</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/\/mockme\/proxy(.*)/</span>)
    <span style="color:#66d9ef">const</span> [, <span style="color:#a6e22e">regUrl</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">urlRegResult</span>
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pathNode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pathToRegexp</span>(<span style="color:#e6db74">&#39;/:projectId/:proxyURL*&#39;</span>).<span style="color:#a6e22e">exec</span>(<span style="color:#a6e22e">regUrl</span>)
    <span style="color:#66d9ef">const</span> [, <span style="color:#a6e22e">projectId</span>, <span style="color:#a6e22e">proxyURL</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">pathNode</span>

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">doc</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">MockAPIModel</span>.<span style="color:#a6e22e">findOne</span>({ <span style="color:#a6e22e">projectId</span>, <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">proxyURL</span> })
  }
}

<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">all</span>(<span style="color:#e6db74">`/mockme/proxy/:id/(.*)`</span>, <span style="color:#a6e22e">proxyAPI</span>)
</code></pre></div><p>这里有几点注意</p>
<ul>
<li>
<p>我们使用 <code>router.all</code> 来覆盖所有的 <code>http method</code>，毕竟不知道业务会有哪些方法</p>
</li>
<li>
<p>通过 <code>path-to-regexp</code> 转换为 url 为正则，方便匹配需要的数据</p>
</li>
</ul>
<h3 id="跨域">跨域</h3>
<p>Q：前面说过代理地址会有跨域问题，那该怎么解决呢？</p>
<p>A：mock 平台配置 <code>cors</code></p>
<p>Q：但是怎么识别请求是真的来自业务呢？<code>cors</code> 只能对白名单列表的 <code>url</code> 开启，</p>
<p>A：业务连接到 mock 平台，可以带个请求头，表明身份</p>
<p>以 <code>axios</code> 为例，只要添加一个 <code>requestInterceptor</code> 即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">axiosInstance</span>.<span style="color:#a6e22e">interceptors</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">use</span>((<span style="color:#a6e22e">config</span>) <span style="color:#f92672">=&gt;</span> {
    <span style="color:#75715e">// 加签校验，配置 mock 请求头
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">serverMode</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">mock</span>) {
      <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">headers</span>[<span style="color:#e6db74">&#39;x-test-mock&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mock-me&#39;</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">config</span>
}, <span style="color:#66d9ef">undefined</span>)
</code></pre></div><p>服务端则检测请求头，进行白名单校验，以 <code>koa</code> 为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(
    <span style="color:#a6e22e">cors</span>({
      <span style="color:#a6e22e">origin</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">ctx</span>: <span style="color:#66d9ef">any</span>) <span style="color:#f92672">=&gt;</span> {
        <span style="color:#75715e">// cors 预检
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">header</span>[<span style="color:#e6db74">&#39;access-control-request-headers&#39;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#e6db74">&#39;x-test-mock&#39;</span>)) {
          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">url</span>
        }

        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">header</span>[<span style="color:#e6db74">&#39;x-test-mock&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;mock-me&#39;</span>) {
          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">url</span>
        }
      },
      <span style="color:#a6e22e">allowHeaders</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;Content-Type&#39;</span>, <span style="color:#e6db74">&#39;x-test-mock&#39;</span>],
    })
  )
</code></pre></div><p>综上，一个简单的 api mock 平台就开发好了，还有更多功能可以扩展，比如 <code>api</code> 自动化测试、实现网页版本 <code>postman</code> 等。</p>



        
      </article>

      
      <aside class="article-aside">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#background">Background</a></li>
    <li><a href="#mock平台">Mock平台</a>
      <ul>
        <li><a href="#创建项目">创建项目</a></li>
        <li><a href="#创建-api">创建 API</a></li>
      </ul>
    </li>
    <li><a href="#业务接入">业务接入</a>
      <ul>
        <li><a href="#mock-option">mock option</a></li>
        <li><a href="#mock-url">mock url</a></li>
        <li><a href="#跨域">跨域</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
      </aside>
    </div>
    
    
    
    
      

    
  </div>

    <footer>
  

<div class="social-icons">
  
    
    
      
      <a href="mailto:?to=xiaopan.wpp@outlook.com" name="Email">
        <em class="fas fa-envelope"></em>
      </a>
    
       &nbsp;&nbsp;&nbsp;
      <a href="https://github.com/ixiaopan" name="GitHub">
        <em class="fab fa-github"></em>
      </a>
    
       &nbsp;&nbsp;&nbsp;
      <a href="https://www.linkedin.com/in/ixiaopan" name="Linkedin">
        <em class="fab fa-linkedin"></em>
      </a>
    
       &nbsp;&nbsp;&nbsp;
      <a href="https://space.bilibili.com/22910840" name="Bilibili">
        <em class="fab fa-youtube"></em>
      </a>
    
  

  
</div>


  
  <div class="container">
    <p class="credits copyright">
      <a href="https://ixiaopan.github.io/blog/about">ixiaopan</a>
      &nbsp;&copy;
      2023
      
      &nbsp;&ndash;&nbsp;
      <em class="fas fa-moon" id="dark-mode-toggle"></em>
    </p>

    <p class="credits theme-by">
      Powered By <a href="https://gohugo.io">Hugo</a>&nbsp;
      Theme
      <a href="https://github.com/matsuyoshi30/harbor">Harbor</a>
    </p>
  </div>
</footer>

  </body>
</html>
